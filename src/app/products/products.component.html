<!-- ============================= -->
<!-- Products Section Main Container -->
<!-- ============================= -->
<div class="page-wrapper">
  <div class="page-content">
    <div class="container-xxl">
      <div class="row">
        <div class="col-12">
          <div class="card">

            <!-- Card Header -->
            <div class="card-header mb-3">
              <div class="row align-items-center">
                <div class="col">
                  <h4 class="card-title">Products</h4>
                </div>
                <div class="col-auto">
                  <div class="d-flex gap-2">
                    <button
                      type="button"
                      class="btn btn-primary"
                      routerLink="/dashboard/newproduct"
                    >
                      <i class="fa-solid fa-plus me-1"></i> Add Product
                    </button>
                    <button
                      type="button"
                      class="btn btn-primary"
                      data-bs-toggle="modal"
                      data-bs-target="#importModal"
                    >
                      <i class="fa-solid fa-file-import me-1"></i> Import Spreadsheet
                    </button>
                  </div>
                </div>
              </div>
            </div>

            <!-- Card Body with Table -->
            <div class="card-body p-0">
              <div class="table-responsive d-none d-md-block">
                <table class="table mb-0 checkbox-all" id="datatable_1">
                  <thead class="table-light">
                    <tr>
                      <th style="width: 16px">
                        <div class="form-check mb-0 ms-n1">
                          <input type="checkbox" class="form-check-input" id="select-all" />
                        </div>
                      </th>
                      <th class="ps-0">Name</th>
                      <th>Category</th>
                      <th>Cost</th>
                      <th>Price</th>
                      <th>Discount</th>
                      <th>VAT</th>
                      <th>Stock Alert</th>
                      <th>Status</th>
                      <th>Date</th>
                      <th class="text-end">Action</th>
                    </tr>
                  </thead>

                  <tbody>
                    <tr *ngFor="let product of products; let i = index">
                      <td>
                        <img
                          [src]="'https://logsinventory.com/LogsBackendFiles/uploads/products/' + product.image"
                          alt="Product"
                          class="img-fluid rounded"
                          style="max-height: 30px; max-width: 30px"
                        />
                      </td>
                      <td class="ps-0">
                        <span class="d-inline-block align-middle product-name">
                          {{ product.name }}
                        </span>
                      </td>
                      <td>{{ product.category }}</td>
                      <td>₦{{ product.cost_price | number: "1.2-2" }}</td>
                      <td>₦{{ product.price | number: "1.2-2" }}</td>

                      <!-- Discount -->
                      <td>
                        <ng-container *ngIf="product.discount_price && product.discount_price != 0; else noDiscount">
                          ₦{{ product.discount_price | number: "1.2-2" }}
                        </ng-container>
                        <ng-template #noDiscount>❌</ng-template>
                      </td>

                      <!-- VAT -->
                      <td>{{ product.vat ? "✅" : "❌" }}</td>

                      <td>{{ product.stock_alert }}</td>

                      <!-- Status -->
                      <td>
                        <span
                          class="badge"
                          [ngClass]="{
                            'bg-success-subtle text-success': product.status === 'active',
                            'bg-danger-subtle text-danger': product.status === 'inactive'
                          }"
                        >
                          <i
                            class="fas me-1"
                            [ngClass]="{
                              'fa-check': product.status === 'active',
                              'fa-times': product.status === 'inactive'
                            }"
                          ></i>
                          {{ product.status }}
                        </span>
                      </td>

                      <td>{{ product.created_at | date : "medium" }}</td>

                      <!-- Actions -->
                      <td class="text-end">
                        <a (click)="openEditModal(product)" class="me-2">
                          <i class="las la-pen text-secondary fs-18"></i>
                        </a>
                        <a (click)="deleteItem(product.id)">
                          <i class="las la-trash-alt text-secondary fs-18"></i>
                        </a>
                      </td>
                    </tr>
                  </tbody>
                </table>
              </div>

              <!-- Mobile Card View -->
              <div class="d-block d-md-none">
                <div class="row">
                  <div class="col-12 mb-3" *ngFor="let product of products">
                    <div class="card shadow-sm border rounded p-2">
                      <div class="d-flex align-items-center">
                        <img
                          [src]="'https://logsinventory.com/LogsBackendFiles/uploads/products/' + product.image"
                          alt="Product"
                          class="rounded me-3"
                          style="width: 70px; height: 70px; object-fit: cover"
                        />
                        <div class="flex-grow-1">
                          <h6 class="mb-1">{{ product.name }}</h6>
                          <small class="text-muted">{{ product.category }}</small>
                          <div class="mt-1">
                            <span class="badge bg-light text-dark me-1">
                              Stock: {{ product.stock_alert }}
                            </span>
                            <span
                              class="badge"
                              [ngClass]="{
                                'bg-success-subtle text-success': product.status === 'active',
                                'bg-danger-subtle text-danger': product.status === 'inactive'
                              }"
                            >
                              {{ product.status }}
                            </span>
                          </div>
                        </div>
                      </div>
                      <div class="mt-2 d-flex justify-content-between align-items-center">
                        <small class="text-muted">₦{{ product.price | number : "1.2-2" }}</small>
                        <div>
                          <a (click)="openEditModal(product)" class="me-2">
                            <i class="las la-pen text-secondary fs-18"></i>
                          </a>
                          <a (click)="deleteItem(product.id)">
                            <i class="las la-trash-alt text-secondary fs-18"></i>
                          </a>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
              <!-- End Mobile Card View -->
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Footer -->
    <footer class="footer text-center text-sm-start d-print-none">
      <div class="container-xxl">
        <div class="row">
          <div class="col-12">
            <div class="card mb-0 rounded-bottom-0">
              <div class="card-body">
                <p class="text-muted mb-0">© Logsinventory</p>
              </div>
            </div>
          </div>
        </div>
      </div>
    </footer>
  </div>
</div>

<!-- Spinner -->
<ngx-spinner type="ball-scale-multiple"></ngx-spinner>

<!-- ============================= -->
<!-- Edit Product Modal -->
<!-- ============================= -->
<div class="modal fade" id="editModal" tabindex="-1">
  <div class="modal-dialog">
    <div class="modal-content">
      <form (ngSubmit)="saveChanges()">
        <div class="modal-header">
          <h5 class="modal-title">Edit Product</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>

        <div class="modal-body">
          <!-- Name -->
          <div class="mb-3">
            <label for="name">Name</label>
            <input id="name" [(ngModel)]="selectedProduct.name" name="name" class="form-control" required />
          </div>

          <!-- Category -->
          <div class="mb-3">
            <label for="category">Category</label>
            <select
              id="category"
              name="category"
              class="form-select"
              [(ngModel)]="selectedProduct.category"
              required
            >
              <option *ngFor="let category of categories" [value]="category.id">
                {{ category.name }}
              </option>
            </select>
          </div>

          <!-- Cost Price -->
          <div class="mb-3">
            <label for="cost_price">Cost Price</label>
            <input id="cost_price" [(ngModel)]="selectedProduct.cost_price" name="cost_price" class="form-control" required />
          </div>

          <!-- Price -->
          <div class="mb-3">
            <label for="price">Price</label>
            <input id="price" [(ngModel)]="selectedProduct.price" name="price" class="form-control" required />
          </div>

          <!-- Discount Price -->
          <div class="mb-3">
            <label for="discount_price">Discount Price</label>
            <input id="discount_price" [(ngModel)]="selectedProduct.discount_price" name="discount_price" class="form-control" />
          </div>

          <!-- Stock Alert -->
          <div class="mb-3">
            <label for="stock_alert">Stock Alert</label>
            <input id="stock_alert" [(ngModel)]="selectedProduct.stock_alert" name="stock_alert" class="form-control" required />
          </div>

          <!-- Description -->
          <div class="mb-3">
            <label for="description">Description</label>
            <textarea
              id="description"
              name="description"
              class="form-control"
              rows="3"
              placeholder="Enter product description"
              [(ngModel)]="selectedProduct.description"
              required
            ></textarea>
          </div>

          <!-- VAT Checkbox -->
          <div class="form-check mb-3">
            <input type="checkbox" id="vat" name="vat" class="form-check-input" [(ngModel)]="selectedProduct.vat" />
            <label for="vat" class="form-check-label">Add VAT (7.5%)</label>
          </div>

          <!-- Current Image Preview -->
          <div class="mb-3">
            <label>Current Image</label><br />
            <img
              [src]="'https://logsinventory.com/LogsBackendFiles/uploads/products/' + selectedProduct.image"
              alt="Current Product Image"
              class="img-thumbnail"
              style="max-height: 100px"
            />
          </div>

          <!-- Upload New Image -->
          <div class="mb-3">
            <label for="imageUpload">Update Product Image</label>
            <input
              id="imageUpload"
              type="file"
              (change)="onImageSelected($event)"
              accept="image/*"
              class="form-control"
            />
          </div>

          <!-- New Image Preview -->
          <div *ngIf="previewImage" class="mb-3">
            <label>Preview Selected Image</label><br />
            <img [src]="previewImage" alt="New Preview" class="img-thumbnail" style="max-height: 100px" />
          </div>
        </div>

        <div class="modal-footer">
          <button type="submit" class="btn btn-success">Save</button>
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
        </div>
      </form>
    </div>
  </div>
</div>

<!-- ============================= -->
<!-- Import Spreadsheet Modal -->
<!-- ============================= -->
<div class="modal fade" id="importModal" tabindex="-1" aria-labelledby="importModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h1 class="modal-title fs-5" id="importModalLabel">Import Product Spreadsheet</h1>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <div class="container-fluid">
          <!-- Template Download -->
          <div class="mb-3">
            <a href="/public/assets/templates/products.xlsx" download>
              <button class="btn btn-outline-primary">Download Template</button>
            </a>
          </div>

          <!-- File Input -->
          <div class="mb-3">
            <input type="file" (change)="onFileChange($event)" accept=".xlsx, .xls" class="form-control" />
          </div>

          <!-- Import Button -->
          <div *ngIf="excelData" class="text-center">
            <button type="submit" class="btn btn-outline-primary mt-3" (click)="addNewProduct()">
              Add Product
            </button>
          </div>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
      </div>
    </div>
  </div>
</div>
